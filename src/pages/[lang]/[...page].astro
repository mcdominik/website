---
import PostsList from '@layouts/PostsList.astro';
import siteConfig from '@config/site';
import { groupPostsByLocales, type PostEntry } from '@lib/content';
import { DEFAULT_LOCALE, SUPPORTED_LOCALES, normalizeLocale } from '@lib/language';
import { ensureTrailingSlash } from '@utils/url';

export async function getStaticPaths({ paginate }) {
  const locales = SUPPORTED_LOCALES;
  const groups = await groupPostsByLocales(locales);

  return groups.flatMap((group) =>
    paginate(group.posts, {
      pageSize: siteConfig.postsPerPage,
      params: { lang: group.lang },
    }),
  );
}

const { lang, page: pageParam } = Astro.params;

if (lang === DEFAULT_LOCALE) {
  const suffix = pageParam ? `/${pageParam}` : '';
  return Astro.redirect(ensureTrailingSlash(suffix || '/'));
}

const { page } = Astro.props;
const posts = page.data as PostEntry[];

const locale = normalizeLocale(lang);

const pageTitle = `${siteConfig.title[locale]} â€” ${siteConfig.description[locale]}`;
const pageDescription = siteConfig.author.bio[locale];
---
<PostsList title={pageTitle} description={pageDescription} posts={posts} page={page} />

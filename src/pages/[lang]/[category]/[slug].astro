---
import PostLayout from '@layouts/Post.astro';
import {
  getCategoryPathSegment,
  getPostCategory,
  getPostLanguage,
  getPostSlug,
  getPosts,
} from '@lib/content';
import { DEFAULT_LOCALE, SUPPORTED_LOCALES } from '@lib/language';
import { ensureTrailingSlash } from '@utils/url';

export async function getStaticPaths() {
  const locales = SUPPORTED_LOCALES;

  const paths = await Promise.all(
    locales.map(async (locale) => {
      const posts = await getPosts({ lang: locale });
      return posts.map((entry) => ({
        params: {
          lang: getPostLanguage(entry),
          category: getCategoryPathSegment(getPostCategory(entry)),
          slug: getPostSlug(entry),
        },
        props: { entry },
      }));
    }),
  );

  return paths.flat();
}

const { lang, category, slug } = Astro.params;

if (lang === DEFAULT_LOCALE) {
  return Astro.redirect(ensureTrailingSlash(`/${category}/${slug}`));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
---
<PostLayout entry={entry} Content={Content} headings={headings} />

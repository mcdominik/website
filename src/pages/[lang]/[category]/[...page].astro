---
import PostsList from '@layouts/PostsList.astro';
import siteConfig from '@config/site';
import {
  findCategoryIdByPathSegment,
  getCategoryConfig,
  getCategoryPathSegment,
  getEnabledCategoryIds,
  groupPostsByLocales,
  type PostEntry,
} from '@lib/content';
import { DEFAULT_LOCALE, SUPPORTED_LOCALES, normalizeLocale } from '@lib/language';
import { ensureTrailingSlash } from '@utils/url';

export async function getStaticPaths({ paginate }) {
  const locales = SUPPORTED_LOCALES;
  const categories = getEnabledCategoryIds();

  const paths = await Promise.all(
    locales.flatMap((locale) =>
      categories.map(async (category) => {
        const [group] = await groupPostsByLocales([locale], { category });
        if (!group) {
          return [];
        }

        return paginate(group.posts, {
          pageSize: siteConfig.postsPerPage,
          params: { lang: locale, category: getCategoryPathSegment(category) },
        });
      }),
    ),
  );

  return paths.flat();
}

const { lang, category, page: pageParam } = Astro.params;

if (lang === DEFAULT_LOCALE) {
  const suffix = pageParam ? `/${pageParam}` : '';
  return Astro.redirect(ensureTrailingSlash(`/${category}${suffix}`));
}

const { page } = Astro.props;
const categorySegment = category;
const posts = page.data as PostEntry[];

const locale = normalizeLocale(lang);
const categoryId =
  findCategoryIdByPathSegment(categorySegment) ?? categorySegment;
const categoryConfig = getCategoryConfig(categoryId);

const categoryLabel =
  categoryConfig?.label?.[locale] ??
  categoryConfig?.label?.[DEFAULT_LOCALE] ??
  categoryId;

const pageTitle = `${siteConfig.title[locale]}: ${categoryLabel}`;
const pageDescription =
  categoryConfig?.description?.[locale] ?? siteConfig.description[locale];
---
<PostsList
  title={pageTitle}
  description={pageDescription}
  posts={posts}
  categoryId={categoryId}
  page={page}
/>

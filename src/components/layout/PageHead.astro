---
import siteConfig from '@config/site';
import { getOgLocale, resolveLocaleDefinition } from '@config/locales';
import { DEFAULT_LOCALE, listNonDefaultLocales } from '@lib/language';

type AlternateLink = {
  lang: string;
  pathname: string;
};

interface PageHeadProps {
  lang: string;
  title: string;
  description?: string;
  keywords?: string;
  canonicalUrl: string;
  alternates: AlternateLink[];
  prev?: string;
  next?: string;
  ogImage: string;
  twitterHandle?: string;
  baseDomain: string;
  fallbackDescription: string;
  enableCodeHighlight?: boolean;
  ogType?: 'website' | 'article';
  publishedAt?: string;
  modifiedAt?: string;
  authorName?: string;
  section?: string;
}

const {
  lang,
  title,
  description,
  keywords,
  canonicalUrl,
  alternates,
  prev,
  next,
  ogImage,
  twitterHandle,
  baseDomain,
  fallbackDescription,
  enableCodeHighlight = false,
  ogType = 'website',
  publishedAt,
  modifiedAt,
  authorName,
  section,
}: PageHeadProps = Astro.props;

const currentLocaleDefinition = resolveLocaleDefinition(lang);
const localeCode = currentLocaleDefinition.code as 'en' | 'pl';
const siteTitle =
  (typeof siteConfig.title === 'string' ? siteConfig.title : siteConfig.title[localeCode]) ??
  (typeof siteConfig.title === 'string' ? siteConfig.title : siteConfig.title[DEFAULT_LOCALE]) ??
  (typeof siteConfig.title === 'string' ? siteConfig.title : Object.values(siteConfig.title)[0]);
const descriptionContent = description ?? fallbackDescription;
const rssTitleDefault =
  (typeof siteConfig.title === 'string' ? siteConfig.title : siteConfig.title[DEFAULT_LOCALE]) ??
  (typeof siteConfig.title === 'string' ? siteConfig.title : siteConfig.title[localeCode]) ??
  (typeof siteConfig.title === 'string' ? siteConfig.title : Object.values(siteConfig.title)[0]);
const ogLocale = getOgLocale(localeCode);
const isArticle = ogType === 'article';
const articleAuthor =
  authorName ??
  (typeof siteConfig.author.name === 'string' ? siteConfig.author.name : siteConfig.author.name[localeCode]) ??
  (typeof siteConfig.author.name === 'string' ? siteConfig.author.name : siteConfig.author.name[DEFAULT_LOCALE]) ??
  (typeof siteConfig.author.name === 'string' ? siteConfig.author.name : Object.values(siteConfig.author.name)[0]);
const publishedTime = publishedAt ?? null;
const modifiedTime = modifiedAt ?? publishedTime;

const toAbsolute = (url?: string) =>
  url ? new URL(url.replace(/\/$/, ''), baseDomain).toString() : undefined;

---
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta name="referrer" content="strict-origin-when-cross-origin" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#1a1a1a" media="(prefers-color-scheme: dark)" />

  <script is:inline src="/js/theme.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  {enableCodeHighlight && (
    <>
      <link rel="preconnect" href="https://cdnjs.cloudflare.com/" />
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" />
      <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.4.0/styles/base16/tomorrow-night.min.css" />
    </>
  )}
  <link rel="manifest" href="/manifest.webmanifest" />
  {enableCodeHighlight && (
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  )}
  <script type="module" src="/js/main.js"></script>

  <title>{title}</title>

  {description && <meta name="description" content={description} />}
  {keywords && <meta name="keywords" content={keywords} />}

  <link rel="canonical" href={canonicalUrl} />

  {alternates.map(({ lang: alternateLang, pathname }) => {
    const normalizedLang = alternateLang.toLowerCase();
    const href = new URL(pathname, baseDomain).toString();

    if (normalizedLang === 'x-default') {
      return <link rel="alternate" hreflang="x-default" href={href} />;
    }

    const alternateDefinition = resolveLocaleDefinition(alternateLang);
    const hreflang = alternateDefinition.langTag ?? alternateDefinition.code;

    return <link rel="alternate" hreflang={hreflang} href={href} />;
  })}

  {prev && <link rel="prev" href={prev} />}
  {next && <link rel="next" href={next} />}

  <meta property="og:title" content={title} />
  <meta property="og:description" content={descriptionContent} />
  <meta property="og:url" content={canonicalUrl} />
  <meta property="og:image" content={ogImage} />
  <meta property="og:type" content={ogType} />
  <meta property="og:site_name" content={siteTitle} />
  <meta property="og:locale" content={ogLocale} />
  {isArticle && (
    <>
      {publishedTime && (
        <meta property="article:published_time" content={publishedTime} />
      )}
      {modifiedTime && (
        <meta property="article:modified_time" content={modifiedTime} />
      )}
      <meta property="article:author" content={articleAuthor} />
      {section && <meta property="article:section" content={section} />}
      <meta name="author" content={articleAuthor} />
    </>
  )}

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={descriptionContent} />
  <meta name="twitter:image" content={ogImage} />
  {twitterHandle && <meta name="twitter:creator" content={twitterHandle} />}

  {siteConfig.features.rss && (
    <>
      <link
        rel="alternate"
        type="application/rss+xml"
        href="/rss.xml"
        title={`${rssTitleDefault} RSS feed`}
      />
      {listNonDefaultLocales()
        .map((code) => (
          <link
            rel="alternate"
            type="application/rss+xml"
            href={`/${code}/rss.xml`}
            title={`${siteConfig.title[code] ?? rssTitleDefault} RSS feed`}
          />
        ))}
    </>
  )}

  {siteConfig.seo.googleAnalytics && (
    <>
      <script async src={`https://www.googletagmanager.com/gtag/js?id=${siteConfig.seo.googleAnalytics}`}></script>
      <script is:inline>
        {`window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', '${siteConfig.seo.googleAnalytics}');`}
      </script>
    </>
  )}

  <script type="application/ld+json" set:html={JSON.stringify(
    isArticle
      ? {
          "@context": "https://schema.org",
          "@type": "Article",
          "headline": title,
          "image": [toAbsolute(ogImage)],
          "datePublished": publishedTime,
          "dateModified": modifiedTime,
          "author": [{
              "@type": "Person",
              "name": articleAuthor,
              "url": toAbsolute("/about")
          }]
        }
      : {
          "@context": "https://schema.org",
          "@type": "WebSite",
          "name": siteTitle,
          "url": baseDomain,
        }
  )} />

  {!isArticle && (
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": (typeof siteConfig.author.name === 'string' ? siteConfig.author.name : siteConfig.author.name[localeCode]) ?? (typeof siteConfig.author.name === 'string' ? siteConfig.author.name : siteConfig.author.name[DEFAULT_LOCALE]) ?? (typeof siteConfig.author.name === 'string' ? siteConfig.author.name : Object.values(siteConfig.author.name)[0]),
      "url": baseDomain,
      "logo": toAbsolute(siteConfig.author.avatar),
      "description": (typeof siteConfig.description === 'string' ? siteConfig.description : siteConfig.description[localeCode]) ?? (typeof siteConfig.description === 'string' ? siteConfig.description : siteConfig.description[DEFAULT_LOCALE]) ?? (typeof siteConfig.description === 'string' ? siteConfig.description : Object.values(siteConfig.description)[0]),
      "sameAs": siteConfig.contactLinks.map(link => {
        const url = link.url;
        return (typeof url === 'string' ? url : url[localeCode]) ?? (typeof url === 'string' ? url : url[DEFAULT_LOCALE]) ?? (typeof url === 'string' ? url : Object.values(url)[0]);
      }).filter(Boolean),
    })} />
  )}
</head>
